<html>
  <head>
    <title>Three.js Boilerplate</title>
  </head>
  <body>
    <div class="input">Choose a song</div>
    <div class="default">Play default song</div>

    <div id="main"></div>

    <script type="x-shader/x-vertex" id="clear-vertexshader">
      void main() {
        gl_Position = vec4(position, 1.0);
      }
    </script>

    <script type="x-shader/x-fragment" id="clear-fragmentshader">
      void main() {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.06);
      }
    </script>

    <script type="x-shader/x-vertex" id="vertexshader">
      uniform float amount;
      uniform float resolution;
      uniform float radius;
      uniform float time;
      uniform float average;
      uniform float thetaFactor;

      varying vec4 color;

      float rand(vec2 co){
          return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
      }

      void main() {
        float curveOffset = position[0];
        float pointOffset = position[1];
        float magnitude = position[2];
        float localRadius = pointOffset/resolution*radius;
        float theta = (magnitude + 1.0)*(pointOffset + curveOffset)*thetaFactor*((sin(time/1000.0 - 1.5707963268) + 1.0)/2.0*2.0 + 0.8);
        float y = (mod(curveOffset, 2.0) == 0.0 ? 1.0 : -1.0)*(average*3.0 + curveOffset*4.0*(0.01 + (time <= 2000.0 && false ? sin(time/540.0 + 1.0)*10.0 + 10.1 : 0.1) + magnitude*(1.0 + magnitude*15.0))*(0.8 + 5.0*(magnitude + average))/amount);
        float curveFactor = curveOffset/100.0;

        // y = (mod(curveOffset, 2.0) == 0.0 ? 1.0 : -1.0)*magnitude;

        gl_Position = projectionMatrix * modelViewMatrix * vec4(
          localRadius*sin(theta) + 0.3*sin(time/50.0*(magnitude + 1.0) + pointOffset)/(0.5/magnitude),
          y,
          localRadius*cos(theta) + 0.3*cos(time/50.0*(magnitude + 1.0) + pointOffset)/(0.5/magnitude),
          1.0
        );

        gl_PointSize = 1.0/distance(gl_Position.xyz, modelViewMatrix[3].xyz);
        if(gl_PointSize > 0.8) gl_PointSize = 0.8;

        color = vec4(
          sin(curveFactor + time/50.0)*0.15 + 0.7,
          sin(curveFactor + time/100.0)*0.15 + 0.7,
          sin(curveFactor + time/200.0)*0.15 + 0.7,
          ((1.0 - curveOffset/amount) - (1.0 - pointOffset/resolution))*0.3 + 0.5
        );
      }
    </script>

    <script type="x-shader/x-fragment" id="fragmentshader">
      varying vec4 color;

      void main() {
        gl_FragColor = color;
      }
    </script>
  </body>
</html>
